server {
    listen 80;
    server_name localhost;

    # CORS headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept' always;

    # Servir les tuiles OSM t√©l√©charg√©es (format z/x/y.png)
    location /tiles/ {
        alias /usr/share/nginx/html/tiles/osm/;
        
        # Cache des tuiles
        expires 365d;
        add_header Cache-Control "public, immutable";
        
        # Type MIME pour les images PNG
        types {
            image/png png;
        }
        
        # D√©sactiver le logging pour les tuiles (performance)
        access_log off;
    }
    
    # Route alternative pour le format standard OSM /{z}/{x}/{y}.png
    location ~ ^/(\d+)/(\d+)/(\d+)\.png$ {
        alias /usr/share/nginx/html/tiles/osm/$1/$2/$3.png;
        
        expires 365d;
        add_header Cache-Control "public, immutable";
        add_header 'Access-Control-Allow-Origin' '*';
        
        types {
            image/png png;
        }
        
        access_log off;
    }

    # Health check
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Page d'accueil avec info
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head><title>Road Reporter - Tile Server</title></head>
<body>
<h1>üó∫Ô∏è Road Reporter Tile Server</h1>
<p>Server is running!</p>
<h3>Available endpoints:</h3>
<ul>
<li><a href="/health">/health</a> - Health check</li>
<li>/tiles/{z}/{x}/{y}.png - OSM Tiles</li>
<li>/{z}/{x}/{y}.png - Alternative tile URL</li>
</ul>
<p>Example: <a href="/tiles/15/5073/4637.png">/tiles/15/5073/4637.png</a></p>
</body>
</html>';
    }
}
